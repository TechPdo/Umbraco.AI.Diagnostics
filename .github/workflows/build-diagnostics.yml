name: Manual Build & NuGet â€“ Umbraco.AI.Diagnostics

on:
  workflow_dispatch:
    inputs:
      publishNuget:
        description: 'Publish to NuGet'
        required: true
        default: 'false'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ---------------------------
    # Checkout
    # ---------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # ---------------------------
    # Determine Semantic Version
    # ---------------------------
    - name: Determine Version
      id: version
      uses: paulhatch/semantic-version@v5
      with:
        tag_prefix: "v"
        initial_version: "1.0.4"
        major_pattern: "BREAKING CHANGE"
        minor_pattern: "feat"
        patch_pattern: "fix"
        format: "${major}.${minor}.${patch}"

    - name: Set VERSION environment variable
      run: echo "VERSION=${{ steps.version.outputs.version }}" >> $GITHUB_ENV

    - name: Print Version
      run: echo "VERSION = $VERSION"
      shell: bash

    # ---------------------------
    # Setup .NET 10 (Umbraco 17)
    # ---------------------------
    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        include-prerelease: true

    # ---------------------------
    # Setup Node / TypeScript
    # ---------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Build TypeScript Client
      working-directory: Umbraco.AI.Diagnostics/Client
      run: |
        npm ci
        npm run build
      shell: bash

    # ---------------------------
    # Restore & Build .NET Project
    # ---------------------------
    - name: Restore .NET Dependencies
      run: dotnet restore Umbraco.AI.Diagnostics/Umbraco.AI.Diagnostics.csproj

    - name: Build .NET Project
      run: dotnet build Umbraco.AI.Diagnostics/Umbraco.AI.Diagnostics.csproj -c Release /p:Version=$VERSION
      shell: bash

    # ---------------------------
    # Pack NuGet Package
    # ---------------------------
    - name: Pack NuGet
      run: dotnet pack Umbraco.AI.Diagnostics/Umbraco.AI.Diagnostics.csproj -c Release -o ./artifacts /p:PackageVersion=$VERSION
      shell: bash

    # ---------------------------
    # Optional: Publish to NuGet (manual only)
    # ---------------------------
    - name: Publish to NuGet
      if: github.event.inputs.publishNuget == 'true'
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
      shell: bash
